window.L = window.L || {};
L.config = L.config || {};
L.method = L.method || {};
L.string = L.string || {};
L.widget = L.widget || {};
L.string.TIMEOUT = "操作超时！";
L.string.SUCCESS = "操作成功！";
L.string.FAILURE = "操作失败！";
L.string.WAITING = "处理中，请稍侯...";
L.string.LOADING = "加载中，请稍侯...";
L.string.POSTING = "发送中，请稍侯...";
L.string.CONFIRM = "确认执行该操作吗？";
L.method.date = function (b, c) {
    var g = c ? new Date(c) : new Date(), e = g.getTime();
    return ("" + b).replace(/a|A|d|D|F|g|G|h|H|i|I|j|l|L|m|M|n|s|S|t|T|U|w|y|Y|z|Z/g, function (d) {
        switch (d) {
            case"a":
                return g.getHours() > 11 ? "pm" : "am";
            case"A":
                return g.getHours() > 11 ? "PM" : "AM";
            case"d":
                return ("0" + g.getDate()).slice(-2);
            case"D":
                return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][g.getDay()];
            case"F":
                return ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][g.getMonth()];
            case"g":
                return (c = (g.getHours() || 12)) > 12 ? c - 12 : c;
            case"G":
                return g.getHours();
            case"h":
                return ("0" + ((c = g.getHours() || 12) > 12 ? c - 12 : c)).slice(-2);
            case"H":
                return ("0" + g.getHours()).slice(-2);
            case"i":
                return ("0" + g.getMinutes()).slice(-2);
            case"I":
                return (function () {
                    g.setDate(1);
                    g.setMonth(0);
                    c = [g.getTimezoneOffset()];
                    g.setMonth(6);
                    c[1] = g.getTimezoneOffset();
                    g.setTime(e);
                    return c[0] == c[1] ? 0 : 1
                })();
            case"j":
                return g.getDate();
            case"l":
                return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][g.getDay()];
            case"L":
                return (c = g.getFullYear()) % 4 == 0 && (c % 100 != 0 || c % 400 == 0) ? 1 : 0;
            case"m":
                return ("0" + (g.getMonth() + 1)).slice(-2);
            case"M":
                return ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][g.getMonth()];
            case"n":
                return g.getMonth() + 1;
            case"s":
                return ("0" + g.getSeconds()).slice(-2);
            case"S":
                return ["th", "st", "nd", "rd"][(c = g.getDate()) < 4 ? c : 0];
            case"t":
                return (function () {
                    g.setDate(32);
                    c = 32 - g.getDate();
                    g.setTime(e);
                    return c
                })();
            case"T":
                return "UTC";
            case"U":
                return ("" + e).slice(0, -3);
            case"w":
                return g.getDay();
            case"y":
                return ("" + g.getFullYear()).slice(-2);
            case"Y":
                return g.getFullYear();
            case"z":
                return (function () {
                    g.setMonth(0);
                    return g.setTime(e - g.setDate(1)) / 86400000
                })();
            default:
                return -g.getTimezoneOffset() * 60
        }
    })
};
L.method.nl2br = function (c, a) {
    return c.replace(/\r\n/g, "\n").replace(/[\r\n]/g, typeof(a) == "undefined" ? "<br>" : a)
};
L.method.htext = function (a) {
    var b = document.createElement("div");
    b.appendChild(document.createTextNode(a));
    return b.innerHTML
};
L.method.confirm = function (a) {
    return confirm(typeof(a) == "undefined" ? L.string.CONFIRM : a)
};
L.method.prepare = function (a) {
    var b = {display: L.widget.display, message: L.string.WAITING};
    $.extend(b, a || {});
    b.display.render({hold: true, mode: "wait", body: b.message})
};
L.method.request = function (a) {
    var b = {
        element: null,
        prepare: L.method.prepare,
        respond: L.method.respond,
        success: L.method.success,
        failure: L.method.failure
    };
    $.extend(b, a || {});
    if (!b.element) {
        if (b._action) {
            $.ajax({
                url: b._action,
                type: b._method || "get",
                data: b._params || "",
                dataType: b._format || "json",
                beforeSend: function (e) {
                    if (b.prepare(b) === false) {
                        e.abort()
                    }
                },
                success: function (e) {
                    b.success(b, e)
                },
                error: function (f, e) {
                    b.failure(b, f, e)
                }
            })
        }
        return false
    }
    b.element = $(b.element);
    if (b.element.is("form")) {
        var d = b.element;
        d.ajaxSubmit({
            dataType: "json", beforeSend: function (e) {
                if (b.prepare(b) === false) {
                    e.abort()
                }
            }, success: function (e) {
                b.success(b, e);
                L.widget.captcha.reload(d.find(".captcha"))
            }, error: function (f, e) {
                b.failure(b, f, e)
            }
        })
    } else {
        var c = b.element;
        $.ajax({
            url: c.attr("href") || c.data("href"), type: "get", dataType: "json", beforeSend: function (e) {
                if (b.prepare(b) === false) {
                    e.abort()
                }
            }, success: function (e) {
                b.success(b, e)
            }, error: function (f, e) {
                b.failure(b, f, e)
            }
        })
    }
    return false
};
L.method.success = function (b, c) {
    var a = {respond: L.method.respond};
    $.extend(a, b || {});
    a.respond(b, c)
};
L.method.respond = function (b, d) {
    var a = {display: L.widget.display, forward: true};
    $.extend(a, b || {});
    var c = [];
    if (d.msg != null && d.msg != "") {
        c.push(d.sta ? d.sta + " " + d.msg : d.msg)
    }
    if (d.err) {
        if (a.forward && d.url) {
            c.push('放弃操作，请 <a href="' + d.url + '">点击这里</a>')
        }
        a.display.render({mode: "warn", head: L.string.FAILURE, body: c.length ? c.join("<br/>") : L.string.FAILURE})
    } else {
        if (a.forward) {
            if (d.url) {
                c.push('继续操作，请 <a href="' + d.url + '">点击这里</a>')
            } else {
                c.push('继续操作，请 <a href="javascript:location.reload()">刷新当前页</a> 或 <a href="javascript:history.go(-1)">返回上一页</a>')
            }
        }
        a.display.render({head: L.string.SUCCESS, body: c.length ? c.join("<br/>") : L.string.SUCCESS})
    }
};
L.method.failure = function (d, f, c) {
    var a = {respond: L.method.respond};
    $.extend(a, d || {});
    var e = {err: 1, sta: 0, msg: "", url: "", dat: {}};
    if (c == "error" || c == "parsererror") {
        var b = $.parseJSON(f.responseText);
        if (b) {
            e = b
        } else {
            e.sta = f.status;
            e.msg = f.statusText
        }
    } else {
        if (c == "timeout") {
            e.sta = 504;
            e.msg = L.string.TIMEOUT
        }
    }
    a.respond(d, e)
};
L.method.operate = function (d, a, c, b) {
    L.method.request({_method: d, _action: a, _params: c, _format: b});
    return false
};
L.widget.display = {};
L.widget.display.locate = function (d) {
    var b = {uqid: ""};
    $.extend(b, d || {});
    var a = $('.dial[data-id="dial' + b.uqid + '"]');
    if (!a.size()) {
        var c = '<div data-id="dial' + b.uqid + '" class="modal hide fade dial" tabindex="-1" role="dialog" aria-hidden="true">    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>    <div class="modal-header dial-head"></div>    <div class="modal-body dial-body"></div>    <div class="modal-footer dial-foot"></div></div>';
        $("body").append(c);
        a = $(a.selector)
    }
    return a
};
L.widget.display.render = function (c) {
    var b = {mode: "", head: "", body: "", foot: "", hold: false};
    $.extend(b, c || {});
    var a = L.widget.display.locate(c);
    if (!a.data("bind")) {
        a.data("bind", true);
        a.on("hide", function () {
            return !$(this).data("hold")
        })
    }
    if (a.data("mode")) {
        a.removeClass("dial-mode-" + a.data("mode"));
        a.data("mode", "")
    }
    if (b.mode) {
        a.data("mode", b.mode);
        a.addClass("dial-mode-" + a.data("mode"))
    }
    a.data("hold", b.hold ? true : false);
    b.hold ? a.find(".close").hide() : a.find(".close").show();
    a.find(".dial-head").html(b.head);
    b.head == "" ? a.find(".dial-head").hide() : a.find(".dial-head").show();
    a.find(".dial-body").html(b.body);
    b.body == "" ? a.find(".dial-body").hide() : a.find(".dial-body").show();
    a.find(".dial-foot").html(b.foot);
    b.foot == "" ? a.find(".dial-foot").hide() : a.find(".dial-foot").show();
    if (a.is(":hidden")) {
        a.modal("show")
    }
};
L.widget.display.remove = function (c) {
    var b = {stay: 0};
    $.extend(b, c || {});
    var a = L.widget.display.locate(c);
    if (a.size() && !a.is(":hidden")) {
        if (b.stay > 0) {
            setTimeout(function () {
                a.modal("hide")
            }, b.stay)
        } else {
            a.modal("hide")
        }
    }
};
L.widget.captcha = {};
L.widget.captcha.create = function (b) {
    b = $(b);
    if (b.hasClass("captcha") && !b.find(".captcha-form").size()) {
        var a = '<div class="captcha-form">    <div class="captcha-btns">        <a href="javascript:;" class="captcha-btns-reload" title="获取新的验证" onclick="L.widget.captcha.reload(this);"></a>        <a href="javascript:;" class="captcha-btns-whatis" title="输入验证码有助于我们识别当前是否机器操作"></a>    </div>    <div class="captcha-show">        <a href="javascript:;" onclick="L.widget.captcha.reload(this);" title="获取新的验证"><img onload="L.widget.captcha.onload(this);" src="/check.jpeg?form=' + (b.data("form") || "") + "&time=" + (new Date).getTime() + '"></a>    </div>    <div class="captcha-main">        <input type="text" class="captcha-code" name="_code" autocomplete="off" placeholder="输入验证码">        <input type="hidden" name="_form" value="' + (b.data("form") || "") + '">    </div></div>';
        b.html(a)
    }
};
L.widget.captcha.onload = function (a) {
    a = $(a).closest(".captcha");
    if (a.size()) {
        a.find(".captcha-code").focus().select();
        a.find(".captcha-form").removeClass("captcha-proc-reload")
    }
};
L.widget.captcha.reload = function (a) {
    a = $(a).closest(".captcha");
    if (a.size()) {
        a.find(".captcha-form").addClass("captcha-proc-reload");
        a.find(".captcha-show img").attr("src", "/check.jpeg?form=" + (a.data("form") || "") + "&time=" + (new Date).getTime())
    }
};
$(function () {
    if ($("body").data("exts-scrollup")) {
        $.scrollUp({
            scrollName: "scrollUp",
            topDistance: "300",
            topSpeed: 300,
            animation: "fade",
            animationInSpeed: 200,
            animationOutSpeed: 200,
            scrollText: "",
            activeOverlay: false
        })
    }
    $(".require-confirm").on("click", function () {
        return L.method.confirm()
    });
    $(".request-ajax-link, .request-ajax-link-with-confirm").on("click", function () {
        if (!$(this).hasClass("request-ajax-link-with-confirm") || L.method.confirm()) {
            L.method.request({element: this})
        }
        return false
    });
    $(".request-ajax-form, .request-ajax-form-with-confirm").on("submit", function () {
        if (!$(this).hasClass("request-ajax-form-with-confirm") || L.method.confirm()) {
            if (window.CKEDITOR) {
                for (instance in CKEDITOR.instances) {
                    CKEDITOR.instances[instance].updateElement()
                }
            }
            L.method.request({element: this})
        }
        return false
    })
});